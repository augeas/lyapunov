<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.12.8' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"theme": "light", "code_editor_font_size": 14, "cell_output": "above", "default_width": "medium", "dataframes": "rich"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "medium", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>lyapunov</title>
    <script type="module" crossorigin src="./assets/index-CGFEuydC.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-C9FDJL8i.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.12.8%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20(See%20the%20%5Bsource-code%5D(https%3A%2F%2Fgithub.com%2Faugeas%2Flyapunov).)%0A%20%20%20%20%20%20%20%20%23%20Lyapunov%20fractals%0A%0A%20%20%20%20%20%20%20%20The%20%5BLyapunov%20Fractal%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FLyapunov_fractal)%20is%20calculated%0A%20%20%20%20%20%20%20%20from%20repeated%20iterations%20of%20the%20%5BLogistic%20Map%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FLogistic_map)%3A%0A%0A%20%20%20%20%20%20%20%20%24%24%20%5CLarge%7Bx_%7Bn%2B1%7D%20%3D%20r_%7Bn%7Dx_%7Bn%7D(x_%7Bn%7D-1)%7D%20%24%24%0A%0A%20%20%20%20%20%20%20%20where%20at%20each%20iteration%20%24r_%7Bn%7D%24%20takes%20values%20from%20some%20repeated%20sequence%2C%20for%20%0A%20%20%20%20%20%20%20%20example%20%24AABAB%24.%20For%20each%20point%20in%20an%20image%20%24A%24%20and%20%24B%24%20take%20the%20values%20of%0A%20%20%20%20%20%20%20%20the%20%24x%24%20and%20%24y%24%20coordinates.%20For%20a%20large%20number%20of%20iterations%20%24N%24%2C%20the%20Lyapunov%0A%20%20%20%20%20%20%20%20exponent%20%24%5Clambda%24%20is%20found%20for%20each%20point%2C%20and%20coloured%20accordingly%3A%0A%0A%20%20%20%20%20%20%20%20%24%24%20%5CLarge%7B%5Clambda%20%3D%20%5Cdfrac%7B1%7D%7BN%7D%5Csum_%7Bn%3D1%7D%5E%7BN%7D%7Cr_%7Bn%7D(1-2x_%7Bn%7D)%7C%7D%20%24%24%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20datetime%20import%20datetime%0A%20%20%20%20import%20io%0A%20%20%20%20import%20itertools%0A%20%20%20%20from%20functools%20import%20partial%0A%20%20%20%20import%20math%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20from%20multiprocessing%20import%20Pool%2C%20shared_memory%0A%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20pass%0A%20%20%20%20import%20os%0A%20%20%20%20import%20subprocess%20as%20sp%0A%20%20%20%20import%20sys%0A%20%20%20%20from%20typing%20import%20Iterable%0A%0A%20%20%20%20from%20matplotlib%20import%20colormaps%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20from%20numpy%20import%20typing%20as%20npt%0A%20%20%20%20from%20PIL%20import%20Image%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Image%2C%0A%20%20%20%20%20%20%20%20Iterable%2C%0A%20%20%20%20%20%20%20%20Pool%2C%0A%20%20%20%20%20%20%20%20colormaps%2C%0A%20%20%20%20%20%20%20%20datetime%2C%0A%20%20%20%20%20%20%20%20io%2C%0A%20%20%20%20%20%20%20%20itertools%2C%0A%20%20%20%20%20%20%20%20math%2C%0A%20%20%20%20%20%20%20%20np%2C%0A%20%20%20%20%20%20%20%20npt%2C%0A%20%20%20%20%20%20%20%20os%2C%0A%20%20%20%20%20%20%20%20partial%2C%0A%20%20%20%20%20%20%20%20shared_memory%2C%0A%20%20%20%20%20%20%20%20sp%2C%0A%20%20%20%20%20%20%20%20sys%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(np%2C%20npt)%3A%0A%20%20%20%20def%20seq_vector(seq%3A%20str%2C%20size%3A%20int%3D128)%20-%3E%20npt.ArrayLike%3A%0A%20%20%20%20%20%20%20%20%22%22%22Take%20a%20string%20of%20letters%20and%20return%20a%20repeating%20array%20of%20ints.%22%22%22%0A%20%20%20%20%20%20%20%20assert%20str.isalpha(seq)%0A%20%20%20%20%20%20%20%20vec%20%3D%20np.fromiter(map(ord%2C%20seq.upper())%2C%20dtype%3Dnp.int32)%20-%2065%0A%20%20%20%20%20%20%20%20reps%20%3D%20size%20%2F%2F%20len(seq)%0A%20%20%20%20%20%20%20%20if%20size%20%25%20len(seq)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.tile(vec%2C%20reps)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.tile(vec%2C%20reps%20%2B%201)%5B%3Asize%5D%0A%20%20%20%20return%20(seq_vector%2C)%0A%0A%0A%40app.cell%0Adef%20_(np%2C%20npt)%3A%0A%20%20%20%20def%20lyapunov(seq%3A%20npt.ArrayLike%2C%20*points%3A%20npt.NDArray)%20-%3E%20npt.NDArray%3A%0A%20%20%20%20%20%20%20%20%22%22%22Compute%20a%20Lyapunov%20fractal.%0A%0A%20%20%20%20%20%20%20%20seq%3A%20Coefficient%20sequence%20as%20a%20Numpy%20array%20of%20ints%20in%20%5B0..N%5D.%0A%20%20%20%20%20%20%20%20points%3A%20List%20of%20N%20arrays%2C%20one%20for%20each%20coefficient%2C%20giving%0A%20%20%20%20%20%20%20%20the%20coefficent%20value%20at%20each%20point%20in%20the%20image.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20coeffs%20%3D%20np.stack(points)%5Bseq%5D%0A%20%20%20%20%20%20%20%20%23%20Somewhat%20profligate%20to%20stack%20up%20all%20the%20coefficients%20like%20that...%0A%20%20%20%20%20%20%20%20n_its%20%3D%20len(seq)%0A%20%20%20%20%20%20%20%20iterates%20%3D%20np.zeros(coeffs.shape)%0A%20%20%20%20%20%20%20%20iterates%5B0%5D%20%3D%200.5%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(1%2C%20n_its)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20prev%20%3D%20iterates%5Bi-1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20iterates%5Bi%5D%20%3D%20coeffs%5Bi%5D%20*%20prev%20*%20(1.0%20-%20prev)%0A%20%20%20%20%20%20%20%20%23%20...but%20we%20*do*%20need%20them%20all%20at%20once%20to%20vectorize%20calculating%20the%20Lyapunov%20exponents%3A%0A%20%20%20%20%20%20%20%20return%20np.log(%0A%20%20%20%20%20%20%20%20%20%20%20%20np.abs(coeffs%5B1%3A%5D%20*%20(1.0%20-%202%20*%20iterates%5B1%3A%5D))%0A%20%20%20%20%20%20%20%20).sum(axis%3D0)%20%2F%20(n_its-1)%0A%20%20%20%20return%20(lyapunov%2C)%0A%0A%0A%40app.cell%0Adef%20_(Image%2C%20colormaps%2C%20np%2C%20npt)%3A%0A%20%20%20%20def%20sigmoid(x%3A%20npt.NDArray)%20-%3E%20npt.NDArray%3A%0A%20%20%20%20%20%20%20%20%22%22%22Hyperboloic%20tangent%20normalized%20from%200%20to%201.%22%22%22%0A%20%20%20%20%20%20%20%20return%200.5%20*%20(1%20%2B%20np.tanh(x))%0A%0A%20%20%20%20def%20render_image(img%3A%20npt.NDArray%2C%20palette%3A%20str%3D'Spectral')%20-%3E%20Image.Image%3A%0A%20%20%20%20%20%20%20%20%22%22%22Colour%20a%20Numpy%20array%20according%20to%20a%20Matplotlib%20palette.%22%22%22%0A%20%20%20%20%20%20%20%20colours%20%3D%20colormaps%5Bpalette%5D%0A%20%20%20%20%20%20%20%20return%20Image.fromarray(%0A%20%20%20%20%20%20%20%20%20%20%20%20(255%20*%20colours(sigmoid(img))).astype(np.uint8)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20render_image%2C%20sigmoid%0A%0A%0A%40app.cell%0Adef%20_(Image%2C%20lyapunov%2C%20np%2C%20render_image%2C%20seq_vector)%3A%0A%20%20%20%20def%20lyapunov_img(sequence%3A%20str%2C%0A%20%20%20%20%20%20%20%20x_min%3A%20float%3D2.0%2C%20x_max%3A%20float%3D4.0%2C%20y_min%3A%20float%3D2.0%2C%20y_max%3A%20float%3D4.0%2C%0A%20%20%20%20%20%20%20%20its%3A%20int%3D100%2C%20width%3A%20int%3D512%2C%20height%3A%20int%3D512%2C%0A%20%20%20%20%20%20%20%20palette%3A%20str%3D'twilight')%20-%3E%20Image.Image%3A%0A%20%20%20%20%20%20%20%20%22%22%22Compute%20a%20Lyapunov%20fractal%20and%20return%20it%20as%20a%20pillow%20image.%0A%0A%20%20%20%20%20%20%20%20sequence%3A%20String%20of%20%22A%22s%20and%20%22B%22s%2C%20try%20%22BBBBBBAAAAAA%22%20for%20%22Zircon%20Zity%22...%0A%20%20%20%20%20%20%20%20x_min%2C%20x_max%2C%20y_min%2C%20y_max%3A%20Image%20boundaries.%0A%20%20%20%20%20%20%20%20its%3A%20Number%20of%20iterations%2C%20try%20400%20for%20sharper%20images.%0A%20%20%20%20%20%20%20%20width%2C%20height%3A%20Image%20size%20in%20pixels.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20seq%20%3D%20seq_vector(sequence%2C%20its)%0A%20%20%20%20%20%20%20%20a_coeff%2C%20b_coeff%20%3D%20np.meshgrid(%0A%20%20%20%20%20%20%20%20%20%20%20%20np.linspace(x_min%2C%20x_max%2C%20width)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20np.linspace(y_max%2C%20y_min%2C%20height)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20indexing%3D'xy'%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20return%20render_image(lyapunov(%0A%20%20%20%20%20%20%20%20%20%20%20%20seq%2C%20a_coeff%2C%20b_coeff)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20palette%3Dpalette)%0A%20%20%20%20return%20(lyapunov_img%2C)%0A%0A%0A%40app.cell%0Adef%20_(colormaps%2C%20mo)%3A%0A%20%20%20%20seq_box%20%3D%20mo.ui.text(value%3D'AABAB'%2C%20label%3D'coefficient%20sequence')%0A%20%20%20%20its_box%20%3D%20mo.ui.number(start%3D50%2C%20stop%3D400%2C%20step%3D50%2C%20value%3D100%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22number%20of%20iterations%22)%0A%20%20%20%20x_img_slider%20%3D%20mo.ui.range_slider(start%3D2.0%2C%20stop%3D4.0%2C%20step%3D0.1%2C%20value%3D%5B2.0%2C%204.0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D'x%20range')%0A%20%20%20%20y_img_slider%20%3D%20mo.ui.range_slider(start%3D2.0%2C%20stop%3D4.0%2C%20step%3D0.1%2C%20value%3D%5B2.0%2C%204.0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D'y%20range')%0A%20%20%20%20cmap_names%20%3D%20%5B'seismic'%2C%20'vanimo'%2C%20'managua'%2C%20'berlin'%2C%20'Spectral'%2C%0A%20%20%20%20%20%20%20%20'twilight'%2C%20'ocean'%2C%20'cubehelix'%2C%20'turbo'%2C%20'plasma'%2C%20'magma'%5D%0A%0A%20%20%20%20palettes%20%3D%20%5Bname%20for%20name%20in%20cmap_names%20if%20name%20in%20colormaps%5D%0A%0A%20%20%20%20colour_box%20%3D%20mo.ui.dropdown(palettes%2C%20value%3D'twilight'%2C%20label%3D'palette')%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20cmap_names%2C%0A%20%20%20%20%20%20%20%20colour_box%2C%0A%20%20%20%20%20%20%20%20its_box%2C%0A%20%20%20%20%20%20%20%20palettes%2C%0A%20%20%20%20%20%20%20%20seq_box%2C%0A%20%20%20%20%20%20%20%20x_img_slider%2C%0A%20%20%20%20%20%20%20%20y_img_slider%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20colour_box%2C%0A%20%20%20%20its_box%2C%0A%20%20%20%20lyapunov%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20render_image%2C%0A%20%20%20%20seq_box%2C%0A%20%20%20%20seq_vector%2C%0A%20%20%20%20x_img_slider%2C%0A%20%20%20%20y_img_slider%2C%0A)%3A%0A%20%20%20%20__IMG_SIZE__%20%3D%20400%0A%0A%20%20%20%20img_x_min%2C%20img_x_max%20%3D%20x_img_slider.value%0A%20%20%20%20img_y_min%2C%20img_y_max%20%3D%20y_img_slider.value%0A%0A%20%20%20%20img_x_points%2C%20img_y_points%20%3D%20np.meshgrid(%0A%20%20%20%20%20%20%20%20np.linspace(img_x_min%2C%20img_x_max%2C%20__IMG_SIZE__)%2C%0A%20%20%20%20%20%20%20%20np.linspace(img_y_max%2C%20img_y_min%2C%20__IMG_SIZE__)%2C%0A%20%20%20%20%20%20%20%20indexing%3D'xy'%0A%20%20%20%20)%0A%0A%20%20%20%20img_seq%20%3D%20seq_vector(%0A%20%20%20%20%20%20%20%20''.join(filter(lambda%20char%3A%20char%20in%20'AB'%2C%20seq_box.value.upper()))%2C%0A%20%20%20%20%20%20%20%20its_box.value%0A%20%20%20%20)%0A%0A%20%20%20%20def%20ui_image()%3A%0A%20%20%20%20%20%20%20%20if%20mo.running_in_notebook()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20render_image(lyapunov(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20img_seq%2C%20img_x_points%2C%20img_y_points)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20palette%3Dcolour_box.value)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20No%20point%20in%20generating%20an%20image%20for%20the%20UI%20if%20we're%20not%20in%20a%20notebook.%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20None%0A%0A%20%20%20%20img%20%3D%20ui_image()%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20__IMG_SIZE__%2C%0A%20%20%20%20%20%20%20%20img%2C%0A%20%20%20%20%20%20%20%20img_seq%2C%0A%20%20%20%20%20%20%20%20img_x_max%2C%0A%20%20%20%20%20%20%20%20img_x_min%2C%0A%20%20%20%20%20%20%20%20img_x_points%2C%0A%20%20%20%20%20%20%20%20img_y_max%2C%0A%20%20%20%20%20%20%20%20img_y_min%2C%0A%20%20%20%20%20%20%20%20img_y_points%2C%0A%20%20%20%20%20%20%20%20ui_image%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(colour_box%2C%20img%2C%20its_box%2C%20mo%2C%20seq_box%2C%20x_img_slider%2C%20y_img_slider)%3A%0A%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20img%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bx_img_slider%2C%20y_img_slider%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20seq_box%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20its_box%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20colour_box%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%22%22%22The%20repeated%20sequence%20of%20coeffecients%20can%20extended%20beyond%20%24A%24%20and%20%24B%24.%20If%20a%20third%2C%20%24C%24%2C%20that%20varies%20over%20time%20is%20added%2C%20then%20an%20animation%20can%20be%20produced.%20More%20pleasingly%2C%20if%20there%20are%20%24C%24%20and%20%24D%24%20coefficients%20in%20a%20sequence%2C%20they%20can%20rotate%20in%20a%20circle%20so%20the%20animation%20can%20return%20to%20the%20start%20and%20repeat.%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(np%2C%20npt)%3A%0A%20%20%20%20def%20rot_coeffs(x%3A%20float%2C%20y%3A%20float%2C%20radius%3A%20float%2C%20n%3A%20int)%20-%3E%20npt.NDArray%3A%0A%20%20%20%20%20%20%20%20%22%22%22Return%20an%20array%20of%20n%20pairs%20of%20coefficients%20centred%20at%20(x%2C%20y)%20with%20radius%20r.%22%22%22%0A%20%20%20%20%20%20%20%20theta%20%3D%20np.linspace(-np.pi%2C%20np.pi%2C%20n)%0A%20%20%20%20%20%20%20%20rot%20%3D%20np.zeros(shape%3D(n%2C%202%2C%202))%0A%20%20%20%20%20%20%20%20rot%5B%3A%2C%200%2C%200%5D%20%3D%20np.cos(theta)%0A%20%20%20%20%20%20%20%20rot%5B%3A%2C%200%2C%201%5D%20%3D%20np.sin(theta)%0A%20%20%20%20%20%20%20%20rot%5B%3A%2C%201%2C%200%5D%20%3D%20-rot%5B%3A%2C%200%2C%201%5D%0A%20%20%20%20%20%20%20%20rot%5B%3A%2C%201%2C%201%5D%20%3D%20rot%5B%3A%2C%200%2C%200%5D%0A%20%20%20%20%20%20%20%20point%20%3D%20np.zeros(shape%3D(1%2C%201%2C%202))%0A%20%20%20%20%20%20%20%20point%5B%3A%2C%20%3A%2C%20-1%5D%20%3D%20radius%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20np.array(%5Bx%2C%20y%5D).reshape((1%2C%201%2C%202))%20%2B%20point%20%40%20rot%0A%20%20%20%20%20%20%20%20).reshape(n%2C%202)%0A%0A%20%20%20%20def%20extra_coeffs(point%3A%20npt.ArrayLike%2C%20shape%3A%20tuple%5Bint%2C%20int%5D)%20-%3E%20tuple%5Bnpt.NDArray%2C%20npt.NDArray%5D%3A%0A%20%20%20%20%20%20%20%20%22%22%22Return%20two%20arrays%20of%20coefficients%20with%20the%20given%20shape%22%22%22%0A%20%20%20%20%20%20%20%20c%2C%20d%20%3D%20point%0A%20%20%20%20%20%20%20%20c_coeff%20%3D%20np.zeros(shape)%0A%20%20%20%20%20%20%20%20c_coeff.fill(c)%0A%20%20%20%20%20%20%20%20d_coeff%20%3D%20np.zeros(shape)%0A%20%20%20%20%20%20%20%20d_coeff.fill(d)%0A%20%20%20%20%20%20%20%20return%20(c_coeff%2C%20d_coeff)%0A%20%20%20%20return%20extra_coeffs%2C%20rot_coeffs%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20palettes)%3A%0A%20%20%20%20rot_seq_box%20%3D%20mo.ui.text(value%3D'AACBABD'%2C%20label%3D'coefficient%20sequence')%0A%20%20%20%20x_rot_range%20%3D%20mo.ui.range_slider(start%3D2.0%2C%20stop%3D4.0%2C%20step%3D0.1%2C%20value%3D%5B2.0%2C%204.0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D'A%20range')%0A%20%20%20%20y_rot_range%20%3D%20mo.ui.range_slider(start%3D2.0%2C%20stop%3D4.0%2C%20step%3D0.1%2C%20value%3D%5B2.0%2C%204.0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D'B%20range')%0A%20%20%20%20rad_box%20%3D%20mo.ui.slider(start%3D0.1%2C%20stop%3D1.0%2C%20step%3D0.05%2C%20value%3D0.25%2C%20label%3D'CD%20radius')%0A%20%20%20%20rot_colour_box%20%3D%20mo.ui.dropdown(palettes%2C%20value%3D'twilight'%2C%20label%3D'palette')%0A%20%20%20%20play_pause%20%3D%20mo.ui.button(label%3D'%E2%8F%AF'%2C%20value%3DFalse%2C%20on_click%3Dlambda%20v%3A%20not%20v)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20play_pause%2C%0A%20%20%20%20%20%20%20%20rad_box%2C%0A%20%20%20%20%20%20%20%20rot_colour_box%2C%0A%20%20%20%20%20%20%20%20rot_seq_box%2C%0A%20%20%20%20%20%20%20%20x_rot_range%2C%0A%20%20%20%20%20%20%20%20y_rot_range%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20play_pause%2C%20rad_box)%3A%0A%20%20%20%20def%20tock()%3A%0A%20%20%20%20%20%20%20%20if%20play_pause.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20mo.ui.refresh(default_interval%3D1%2C%20options%3D%5B0.5%2C%201%2C%202%5D)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20''%0A%0A%20%20%20%20c_centre_slider%20%3D%20mo.ui.slider(start%3D2%2Brad_box.value%2C%20stop%3D4-rad_box.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20step%3D0.05%2C%20value%3D3%2C%20label%3D'C%20centre')%0A%20%20%20%20d_centre_slider%20%3D%20mo.ui.slider(start%3D2%2Brad_box.value%2C%20stop%3D4-rad_box.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20step%3D0.05%2C%20value%3D3%2C%20label%3D'D%20centre')%0A%20%20%20%20return%20c_centre_slider%2C%20d_centre_slider%2C%20tock%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20__IMG_SIZE__%2C%0A%20%20%20%20c_centre_slider%2C%0A%20%20%20%20d_centre_slider%2C%0A%20%20%20%20itertools%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20rad_box%2C%0A%20%20%20%20rot_coeffs%2C%0A%20%20%20%20tock%2C%0A%20%20%20%20x_rot_range%2C%0A%20%20%20%20y_rot_range%2C%0A)%3A%0A%20%20%20%20tick%20%3D%20tock()%0A%0A%20%20%20%20rot_x_min%2C%20rot_x_max%20%3D%20x_rot_range.value%0A%20%20%20%20rot_y_min%2C%20rot_y_max%20%3D%20y_rot_range.value%0A%0A%20%20%20%20rot_img_x_points%2C%20rot_img_y_points%20%3D%20np.meshgrid(%0A%20%20%20%20%20%20%20%20np.linspace(rot_x_min%2C%20rot_x_max%2C%20__IMG_SIZE__)%2C%0A%20%20%20%20%20%20%20%20np.linspace(rot_y_max%2C%20rot_y_min%2C%20__IMG_SIZE__)%2C%0A%20%20%20%20%20%20%20%20indexing%3D'xy'%0A%20%20%20%20)%0A%0A%20%20%20%20rot_img_coeffs%20%3D%20rot_coeffs(c_centre_slider.value%2C%20d_centre_slider.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rad_box.value%2C%20360)%0A%0A%20%20%20%20rot_img_slider%20%3D%20mo.ui.slider(start%3D0%2C%20stop%3D359%2C%20step%3D1%2C%20label%3D'CD%20rotation')%0A%0A%20%20%20%20cycle%20%3D%20itertools.cycle(range(0%2C%20360%2C%202))%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20cycle%2C%0A%20%20%20%20%20%20%20%20rot_img_coeffs%2C%0A%20%20%20%20%20%20%20%20rot_img_slider%2C%0A%20%20%20%20%20%20%20%20rot_img_x_points%2C%0A%20%20%20%20%20%20%20%20rot_img_y_points%2C%0A%20%20%20%20%20%20%20%20rot_x_max%2C%0A%20%20%20%20%20%20%20%20rot_x_min%2C%0A%20%20%20%20%20%20%20%20rot_y_max%2C%0A%20%20%20%20%20%20%20%20rot_y_min%2C%0A%20%20%20%20%20%20%20%20tick%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(cycle%2C%20play_pause%2C%20rot_img_slider%2C%20tick)%3A%0A%20%20%20%20tick%0A%20%20%20%20if%20play_pause.value%3A%0A%20%20%20%20%20%20%20%20rotation%20%3D%20cycle.__next__()%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20rotation%20%3D%20rot_img_slider.value%0A%20%20%20%20return%20(rotation%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20extra_coeffs%2C%0A%20%20%20%20lyapunov%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20render_image%2C%0A%20%20%20%20rot_colour_box%2C%0A%20%20%20%20rot_img_coeffs%2C%0A%20%20%20%20rot_img_x_points%2C%0A%20%20%20%20rot_img_y_points%2C%0A%20%20%20%20rot_seq_box%2C%0A%20%20%20%20rotation%2C%0A%20%20%20%20seq_vector%2C%0A)%3A%0A%20%20%20%20rot_img_c%2C%20rot_img_d%20%3D%20extra_coeffs(%0A%20%20%20%20%20%20%20%20rot_img_coeffs%5Brotation%5D%2C%0A%20%20%20%20%20%20%20%20rot_img_x_points.shape%0A%20%20%20%20)%0A%0A%20%20%20%20rot_img_seq%20%3D%20seq_vector(%0A%20%20%20%20%20%20%20%20''.join(filter(lambda%20char%3A%20char%20in%20'ABCD'%2C%20rot_seq_box.value.upper()))%2C%20100%0A%20%20%20%20)%0A%0A%20%20%20%20if%20mo.running_in_notebook()%3A%0A%20%20%20%20%20%20%20%20rot_img%20%3D%20render_image(%0A%20%20%20%20%20%20%20%20%20%20%20%20lyapunov(rot_img_seq%2C%20rot_img_x_points%2C%20rot_img_y_points%2C%20rot_img_c%2C%20rot_img_d)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20palette%3Drot_colour_box.value%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20rot_img%20%3D%20None%0A%20%20%20%20return%20rot_img%2C%20rot_img_c%2C%20rot_img_d%2C%20rot_img_seq%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20c_centre_slider%2C%0A%20%20%20%20d_centre_slider%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20play_pause%2C%0A%20%20%20%20rad_box%2C%0A%20%20%20%20rot_colour_box%2C%0A%20%20%20%20rot_img%2C%0A%20%20%20%20rot_img_slider%2C%0A%20%20%20%20rot_seq_box%2C%0A%20%20%20%20tick%2C%0A%20%20%20%20x_rot_range%2C%0A%20%20%20%20y_rot_range%2C%0A)%3A%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20rot_img%2C%20rot_seq_box%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bx_rot_range%2C%20y_rot_range%5D%2C%20justify%3D'start')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bc_centre_slider%2C%20d_centre_slider%5D%2C%20justify%3D'start')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Brad_box%2C%20rot_img_slider%5D%2C%20justify%3D'start')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Brot_colour_box%2C%20play_pause%2C%20tick%5D%2C%20justify%3D'start')%0A%20%20%20%20%5D%2C%20align%3D'center')%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(np%2C%20shared_memory)%3A%0A%20%20%20%20def%20get_shared_np(shape%3A%20tuple%5Bint%2C%20...%5D%2C%20dtype%3A%20str%3D'float64'%2C%20name%3DNone)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Return%20a%20SharedMemory%20instance%2C%20and%20a%20numpy%20array%20of%20the%20given%0A%20%20%20%20%20%20%20%20shape%20that%20points%20to%20it.%22%22%22%0A%20%20%20%20%20%20%20%20dtype%20%3D%20np.dtype(dtype)%0A%20%20%20%20%20%20%20%20size%3Ddtype.itemsize%20*%20np.prod(shape)%0A%20%20%20%20%20%20%20%20if%20name%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20buff%20%3D%20shared_memory.SharedMemory(create%3DTrue%2C%20size%3Dsize)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20buff%20%3D%20shared_memory.SharedMemory(name%3Dname%2C%20create%3DFalse%2C%20size%3Dsize)%0A%20%20%20%20%20%20%20%20arr%20%3D%20np.ndarray(shape%2C%20dtype%2C%20buffer%3Dbuff.buf)%0A%20%20%20%20%20%20%20%20return%20buff%2C%20arr%0A%20%20%20%20return%20(get_shared_np%2C)%0A%0A%0A%40app.cell%0Adef%20_(extra_coeffs%2C%20get_shared_np%2C%20lyapunov%2C%20sigmoid)%3A%0A%20%20%20%20def%20lyapunov_mp(cd_out%3A%20tuple%5Btuple%5Bfloat%2C%20float%5D%2C%20str%5D%2C%20shape%3A%20tuple%5Bint%2C%20int%5D%2C%0A%20%20%20%20%20%20%20%20its%3A%20int%2C%20seq_name%3A%20str%2C%20x_name%3A%20str%2C%20y_name%3A%20str)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Compute%20a%20Lyapunov%20fractal%20using%20arrays%20backed%20by%20shared%20memory.%0A%0A%20%20%20%20%20%20%20%20cd_out%3A%20Tuple%20that%20allows%20the%20function%20to%20be%20called%20by%20Pool.imap%20containing%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20cd%3A%20Tuple%20of%20floats%20giving%20the%20C%2C%20D%20coefficients%20constant%20across%20the%20image.%0A%20%20%20%20%20%20%20%20%20%20%20%20out_name%3A%20Name%20of%20a%20SharedMemory%20buffer%20to%20hold%20the%20Lyapunov%20exponents.%0A%20%20%20%20%20%20%20%20shape%3A%20Tuple%20of%20ints%20giving%20the%20shape%20of%20the%20A%2C%20B%20coefficient%20and%20output%20arrays.%0A%20%20%20%20%20%20%20%20its%3A%20Number%20of%20iterations%2C%20the%20length%20of%20the%20sequence%20array.%0A%20%20%20%20%20%20%20%20seq_name%3A%20Name%20of%20a%20SharedMemory%20buffer%20pointing%20to%20the%20coefficient%20sequence%20array.%0A%20%20%20%20%20%20%20%20x_name%2C%20y_name%3A%20Names%20of%20SharedMemory%20buffers%20pointing%20to%20the%20A%20and%20B%20coefficient%20arrays.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20cd%2C%20out_name%20%3D%20cd_out%0A%20%20%20%20%20%20%20%20seq_buff%2C%20seq_vec%20%3D%20get_shared_np((its%2C)%2C%20dtype%3D'int32'%2C%20name%3Dseq_name)%0A%20%20%20%20%20%20%20%20x_buff%2C%20x_coeff%20%3D%20get_shared_np(shape%2C%20name%3Dx_name)%0A%20%20%20%20%20%20%20%20y_buff%2C%20y_coeff%20%3D%20get_shared_np(shape%2C%20name%3Dy_name)%0A%20%20%20%20%20%20%20%20out_buff%2C%20out%20%3D%20get_shared_np(shape%2C%20name%3Dout_name)%0A%20%20%20%20%20%20%20%20c_coeff%2C%20d_coeff%20%3D%20extra_coeffs(cd%2C%20shape)%0A%20%20%20%20%20%20%20%20%23%20Don't%20use%20the%20%22render_image%22%20function%2C%20keep%20the%20sigmoid%20function%20inside%20the%20Pool%3A%0A%20%20%20%20%20%20%20%20out%5B%3A%2C%20%3A%5D%20%3D%20sigmoid(lyapunov(seq_vec%2C%20x_coeff%2C%20y_coeff%2C%20c_coeff%2C%20d_coeff))%0A%20%20%20%20%20%20%20%20for%20buff%20in%20(seq_buff%2C%20x_buff%2C%20y_buff%2C%20out_buff)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20buff.close()%0A%20%20%20%20%20%20%20%20return%20out_name%0A%20%20%20%20return%20(lyapunov_mp%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20Image%2C%0A%20%20%20%20Pool%2C%0A%20%20%20%20colormaps%2C%0A%20%20%20%20get_shared_np%2C%0A%20%20%20%20io%2C%0A%20%20%20%20lyapunov_mp%2C%0A%20%20%20%20np%2C%0A%20%20%20%20partial%2C%0A%20%20%20%20rot_coeffs%2C%0A%20%20%20%20seq_vector%2C%0A)%3A%0A%20%20%20%20def%20video_seq_mp(seq%3A%20str%2C%20x_mi%3A%20float%2C%20x_mx%3A%20float%2C%20y_mi%3A%20float%2C%20y_mx%3A%20float%2C%0A%20%20%20%20%20%20%20%20x%3A%20float%2C%20y%3A%20float%2C%20r%3A%20float%2C%20n%3A%20int%2C%0A%20%20%20%20%20%20%20%20cores%3A%20int%2C%0A%20%20%20%20%20%20%20%20its%3A%20int%3D100%2C%20pal%3A%20str%3D'managua'%2C%20w%3A%20int%3D512%2C%20h%3A%20int%3D512)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Yield%20an%20animated%20sequence%20of%20Lyapunov%20images%20using%20multiprocessing%20and%20SharedMemory.%0A%0A%20%20%20%20%20%20%20%20seq%3A%20String%20representing%20the%20repeating%20coefficient%20sequence%2C%20e.g%3A%20%22AACBABD%22.%0A%20%20%20%20%20%20%20%20x_mi%2C%20y_mi%2C%20x_mx%2C%20y_mx%3A%20Floats%20describing%20the%20boundaries%20of%20the%20images%2C%20the%20ranges%0A%20%20%20%20%20%20%20%20of%20the%20A%20and%20B%20coefficients.%0A%20%20%20%20%20%20%20%20x%2C%20y%2C%20r%3A%20Floats%20giving%20the%20centre%20and%20radius%20of%20a%20circle%20on%20which%20the%20C%2C%20D%20coefficients%20lie.%0A%20%20%20%20%20%20%20%20n%3A%20Number%20of%20points%20around%20the%20circle%2C%20the%20number%20of%20frames.%0A%20%20%20%20%20%20%20%20cores%3A%20Number%20of%20cores%20to%20use%20in%20the%20Pool%2C%20not%20including%20the%20calling%20process%20which%0A%20%20%20%20%20%20%20%20compresses%20the%20image%20and%20the%20ffmpeg%20process%20that%20consumes%20them.%0A%20%20%20%20%20%20%20%20its%3A%20Number%20of%20iterations%20for%20each%20image.%0A%20%20%20%20%20%20%20%20pal%3A%20Name%20of%20the%20Matplotlib%20palette%20to%20use.%0A%20%20%20%20%20%20%20%20w%2C%20h%3A%20Image%20width%20and%20height.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20img_shape%20%3D%20(h%2C%20w)%0A%20%20%20%20%20%20%20%20%22%22%22The%20sequence%20of%20images%20is%20divided%20into%20n_chunks%20chunks%20of%20size%20chunk_size%2C%0A%20%20%20%20%20%20%20%20each%20with%20a%20block%20of%20SharedMemory%20to%20hold%20each%20image%20before%20it%20is%20yielded.%0A%20%20%20%20%20%20%20%20pool_chunk_size%20images%20are%20computed%20by%20the%20Pool%20at%20a%20time.%0A%20%20%20%20%20%20%20%20%22%22%22%20%20%20%20%0A%20%20%20%20%20%20%20%20chunk_size%20%3D%208%20*%20cores%0A%20%20%20%20%20%20%20%20n_chunks%20%3D%20n%20%2F%2F%20chunk_size%0A%0A%20%20%20%20%20%20%20%20%23%20Reserve%20SharedMemory%20for%20the%20coefficient%20sequence%20and%20A%2C%20B%20coefficients%3A%0A%20%20%20%20%20%20%20%20seq_buff%2C%20seq_vec%20%3D%20get_shared_np((its%2C)%2C%20'int32')%0A%20%20%20%20%20%20%20%20x_buff%2C%20x_coeff%20%3D%20get_shared_np(img_shape)%0A%20%20%20%20%20%20%20%20y_buff%2C%20y_coeff%20%3D%20get_shared_np(img_shape)%0A%0A%20%20%20%20%20%20%20%20x_coeff%5B%3A%5D%2C%20y_coeff%5B%3A%5D%20%3D%20np.meshgrid(%0A%20%20%20%20%20%20%20%20%20%20%20%20np.linspace(x_mi%2C%20x_mx%2C%20w)%2C%20np.linspace(y_mx%2C%20y_mi%2C%20h)%2C%0A%20%20%20%20%20%20%20%20indexing%3D'xy')%0A%20%20%20%20%20%20%20%20seq_vec%5B%3A%5D%20%3D%20seq_vector(seq%2C%20its)%0A%0A%20%20%20%20%20%20%20%20%23%20Reserve%20SharedMemory%20for%20the%20images.%0A%20%20%20%20%20%20%20%20out_buffs%2C%20out_arrays%20%3D%20zip(*%5Bget_shared_np(img_shape)%20for%20_%20in%20range(chunk_size)%5D)%0A%20%20%20%20%20%20%20%20out_map%20%3D%20%7Bbuff.name%3A%20array%20for%20buff%2C%20array%20in%20zip(out_buffs%2C%20out_arrays)%7D%0A%0A%20%20%20%20%20%20%20%20cd_coeff%20%3D%20rot_coeffs(x%2C%20y%2C%20r%2C%20n)%0A%0A%20%20%20%20%20%20%20%20%22%22%22All%20the%20arguments%20of%20lyapunov_mp%20remain%20constant%2C%20except%20for%20the%20C%2C%20D%20coefficients%0A%20%20%20%20%20%20%20%20and%20the%20name%20of%20the%20output%20buffer%20to%20hold%20the%20image.%20Thus%2C%20no%20large%20numpy%20arrays%20will%0A%20%20%20%20%20%20%20%20be%20serialized%20when%20the%20function%20is%20passed%20to%20the%20Pool.%22%22%22%0A%20%20%20%20%20%20%20%20lyap%20%3D%20partial(lyapunov_mp%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20shape%3Dimg_shape%2C%20its%3Dits%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20seq_name%3Dseq_buff.name%2C%20x_name%3Dx_buff.name%2C%20y_name%3Dy_buff.name%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20colours%20%3D%20colormaps%5Bpal%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Divide%20the%20C%2C%20D%20coefficients%20among%20the%20chunks.%0A%20%20%20%20%20%20%20%20chunks%20%3D%20np.array_split(cd_coeff%2C%20n_chunks)%0A%0A%20%20%20%20%20%20%20%20with%20Pool(cores)%20as%20pool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20chunk%20in%20chunks%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20out_name%20in%20pool.imap(lyap%2C%20zip(chunk%2C%20out_map.keys()))%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20buff%20%3D%20io.BytesIO()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22The%20job%20of%20turning%20the%20returned%20arrays%20to%20images%20is%20left%20to%20the%20calling%20process.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20There's%20no%20point%20compressing%20the%20images%20when%20ffmpeg%20would%20have%20to%20uncompress%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20them%20afterwards.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Image.fromarray(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(255%20*%20colours(out_map%5Bout_name%5D)).astype(np.uint8)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).save(buff%2C%20format%3D'PNG'%2C%20compress_level%3D0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20yield%20buff.getvalue()%0A%0A%20%20%20%20%20%20%20%20for%20shm%20in%20(seq_buff%2C%20x_buff%2C%20y_buff)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20shm.close()%0A%20%20%20%20%20%20%20%20%20%20%20%20shm.unlink%0A%0A%20%20%20%20%20%20%20%20for%20shm%20in%20out_buffs%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20shm.close()%0A%20%20%20%20%20%20%20%20%20%20%20%20shm.unlink()%0A%0A%20%20%20%20%20%20%20%20%23%20Need%20to%20yield%20something%20so%20that%20the%20SharedMemory%20is%20freed.%0A%20%20%20%20%20%20%20%20yield%20None%0A%20%20%20%20return%20(video_seq_mp%2C)%0A%0A%0A%40app.cell%0Adef%20_(sp)%3A%0A%20%20%20%20def%20render_video(fname%3A%20str%2C%20im_seq%2C%20fps%3A%20int%3D30%2C%20quiet%3A%20bool%3DTrue)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Stream%20a%20sequence%20of%20.png%20images%20to%20ffmpeg%2C%20and%20turn%20them%20into%20an%20.mp4%20video.%0A%20%20%20%20%20%20%20%20fname%3A%20Filename%20for%20the%20video.%0A%20%20%20%20%20%20%20%20fps%3A%20Frames%20per%20second%2C%20defaults%20to%2030.%0A%20%20%20%20%20%20%20%20quiet%3A%20Whether%20to%20suppress%20ffmpeg's%20rather%20verbose%20output.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20ffmpeg_cmd%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20'ffmpeg'%2C%20'-threads'%2C%20'1'%2C%20'-f'%2C%20'image2pipe'%2C%20'-vcodec'%2C%20'png'%2C%20'-r'%2C%20str(fps)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'-i'%2C%20'-'%2C%20'-vcodec'%2C%20'libx264'%2C%20'-q%3Aa'%2C%20'0'%2C%20fname%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20if%20quiet%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20ffmpeg_out%20%3D%20sp.DEVNULL%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20ffmpeg_out%20%3D%20None%0A%20%20%20%20%20%20%20%20proc%20%3D%20sp.Popen(ffmpeg_cmd%2C%20stdin%3Dsp.PIPE%2C%20stdout%3Dffmpeg_out%2C%20stderr%3Dffmpeg_out)%0A%20%20%20%20%20%20%20%20%23%20Filter%20the%20sequence%20to%20omit%20the%20finall%20%22None%22.%0A%20%20%20%20%20%20%20%20for%20im%20in%20filter(None%2C%20im_seq)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20proc.stdin.write(im)%0A%20%20%20%20%20%20%20%20proc.stdin.close()%0A%20%20%20%20%20%20%20%20proc.wait()%0A%20%20%20%20return%20(render_video%2C)%0A%0A%0A%40app.cell%0Adef%20_(os)%3A%0A%20%20%20%20__TOTAL_CORES__%20%3D%20int(os.environ.get('OMP_NUM_THREADS'%2C%201))%0A%20%20%20%20if%20__TOTAL_CORES__%20%3E%202%3A%0A%20%20%20%20%20%20%20%20__MAX_VID_SEQ_CORES__%20%3D__TOTAL_CORES__%20-%202%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20__MAX_VID_SEQ_CORES__%20%3D%201%0A%20%20%20%20return%20__MAX_VID_SEQ_CORES__%2C%20__TOTAL_CORES__%0A%0A%0A%40app.cell%0Adef%20_(__MAX_VID_SEQ_CORES__%2C%20mo%2C%20rot_seq_box)%3A%0A%20%20%20%20duration_slider%20%3D%20mo.ui.slider(start%3D10%2C%20stop%3D300%2C%20value%3D60%2C%20label%3D'duration%20(s)')%0A%20%20%20%20fps_dropdown%20%3D%20mo.ui.dropdown(options%3D%5B'24'%2C%20'25'%2C%20'30'%2C%20'50'%2C%20'60'%5D%2C%20value%3D'30'%2C%20label%3D'fps')%0A%20%20%20%20vid_size_dropdown%20%3D%20mo.ui.dropdown(options%3D%5B'512x512'%2C%20'640x480'%2C%20'1280x720'%2C%20'1024x1024'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'1080x1080'%5D%2C%20value%3D'512x512')%0A%20%20%20%20cores_dropdown%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Dlist(map(str%2C%20range(1%2C%20__MAX_VID_SEQ_CORES__%2B1)))%2C%0A%20%20%20%20%20%20%20%20value%3D'1'%2C%20label%3D'cores'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20)%0A%20%20%20%20video_fname%20%3D%20mo.ui.text(value%3D'%7B%7D.mp4'.format(rot_seq_box.value))%0A%20%20%20%20do_video%20%3D%20mo.ui.run_button(label%3D'generate%20video')%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20cores_dropdown%2C%0A%20%20%20%20%20%20%20%20do_video%2C%0A%20%20%20%20%20%20%20%20duration_slider%2C%0A%20%20%20%20%20%20%20%20fps_dropdown%2C%0A%20%20%20%20%20%20%20%20vid_size_dropdown%2C%0A%20%20%20%20%20%20%20%20video_fname%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20c_centre_slider%2C%0A%20%20%20%20cores_dropdown%2C%0A%20%20%20%20d_centre_slider%2C%0A%20%20%20%20duration_slider%2C%0A%20%20%20%20fps_dropdown%2C%0A%20%20%20%20its_box%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20rad_box%2C%0A%20%20%20%20rot_colour_box%2C%0A%20%20%20%20rot_seq_box%2C%0A%20%20%20%20rot_x_max%2C%0A%20%20%20%20rot_x_min%2C%0A%20%20%20%20rot_y_max%2C%0A%20%20%20%20rot_y_min%2C%0A%20%20%20%20vid_size_dropdown%2C%0A%20%20%20%20video_seq_mp%2C%0A)%3A%0A%20%20%20%20video_fps%20%3D%20int(fps_dropdown.value)%0A%20%20%20%20video_frames%20%3D%20duration_slider.value%20*%20video_fps%0A%20%20%20%20vid_width%2C%20vid_height%20%3D%20map(int%2C%20vid_size_dropdown.value.split('x'))%0A%0A%20%20%20%20if%20mo.running_in_notebook()%3A%0A%20%20%20%20%20%20%20%20vs%20%3D%20video_seq_mp(%0A%20%20%20%20%20%20%20%20%20%20%20%20rot_seq_box.value.upper()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20rot_x_min%2C%20rot_x_max%2C%20rot_y_min%2C%20rot_y_max%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20c_centre_slider.value%2C%20d_centre_slider.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20rad_box.value%2C%20video_frames%2C%20int(cores_dropdown.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20its_box.value%2C%20rot_colour_box.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20vid_width%2C%20vid_height%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20vs%20%3D%20%5B%5D%0A%20%20%20%20return%20vid_height%2C%20vid_width%2C%20video_fps%2C%20video_frames%2C%20vs%0A%0A%0A%40app.cell%0Adef%20_(do_video%2C%20mo%2C%20render_video%2C%20video_fname%2C%20video_fps%2C%20video_frames%2C%20vs)%3A%0A%20%20%20%20if%20do_video.value%20and%20mo.running_in_notebook()%3A%0A%20%20%20%20%20%20%20%20def%20vid_seq()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20with%20mo.status.progress_bar(total%3Dvideo_frames)%20as%20prog%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20frame%20in%20vs%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20yield%20frame%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prog.update()%0A%20%20%20%20%20%20%20%20render_video(video_fname.value%2C%20vid_seq()%2C%20fps%3Dvideo_fps)%0A%20%20%20%20return%20(vid_seq%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20cores_dropdown%2C%0A%20%20%20%20do_video%2C%0A%20%20%20%20duration_slider%2C%0A%20%20%20%20fps_dropdown%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20sys%2C%0A%20%20%20%20vid_size_dropdown%2C%0A%20%20%20%20video_fname%2C%0A)%3A%0A%20%20%20%20if%20'pyodide'%20not%20in%20sys.modules%3A%0A%20%20%20%20%20%20%20%20video_ui%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bvid_size_dropdown%2C%20duration_slider%2C%20fps_dropdown%5D%2C%20justify%3D'start')%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bcores_dropdown%2C%20video_fname%2C%20do_video%5D%2C%20justify%3D'start')%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20video_ui%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20'No%20video%20generation%20in%20web-assembly.'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Needs%20multiprocessing%2C%20subprocess%20and%20ffmpeg.'%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20mo.vstack(video_ui%2C%20align%3D'center')%0A%20%20%20%20return%20(video_ui%2C)%0A%0A%0A%40app.cell%0Adef%20_(__MAX_VID_SEQ_CORES__)%3A%0A%20%20%20%20%23%20Cores%20refers%20to%20the%20number%20of%20cores%20used%20to%20create%20the%20image%20sequence.%0A%20%20%20%20%23%20Don't%20forget%20one%20for%20ffmpeg%2C%20and%20one%20to%20pass%20the%20images%20to%20it.%0A%0A%20%20%20%20__DEFAULT_ARGS__%20%3D%20%7B%0A%20%20%20%20%20%20%20%20'seq'%3A%20'AACBABD'%2C%0A%20%20%20%20%20%20%20%20'xmin'%3A%202.0%2C%20'xmax'%3A%204.0%2C%20'ymin'%3A%202.0%2C%20'ymax'%3A%204.0%2C%0A%20%20%20%20%20%20%20%20'xc'%3A%203.0%2C%20'yc'%3A%203.0%2C%20'rad'%3A%200.2%2C%20'its'%3A%20100%2C%0A%20%20%20%20%20%20%20%20'width'%3A%20512%2C%20'height'%3A%20512%2C%20'dur'%3A%2060%2C%20'fps'%3A%2030%2C%0A%20%20%20%20%20%20%20%20'cores'%3A%20__MAX_VID_SEQ_CORES__%2C%20'pal'%3A%20'managua'%0A%20%20%20%20%7D%0A%20%20%20%20return%20(__DEFAULT_ARGS__%2C)%0A%0A%0A%40app.cell%0Adef%20_(__DEFAULT_ARGS__%2C%20datetime%2C%20mo%2C%20render_video%2C%20video_seq_mp)%3A%0A%20%20%20%20%23%20If%20this%20is%20being%20run%20as%20a%20script%3A%0A%20%20%20%20if%20not%20mo.running_in_notebook()%3A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20This%20will%20break%20if%20the%20notebook%20is%20exported.%0A%20%20%20%20%20%20%20%20%20%20%20%20args%20%3D%20mo.cli_args()%0A%20%20%20%20%20%20%20%20%20%20%20%20exported%20%3D%20False%0A%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20args%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20exported%20%3D%20True%0A%20%20%20%20%20%20%20%20def%20get_arg(arg)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20args.get(arg%2C%20__DEFAULT_ARGS__.get(arg))%0A%20%20%20%20%20%20%20%20sq%20%3D%20args.get('seq')%0A%20%20%20%20%20%20%20%20fname%20%3D%20args.get('fname')%0A%0A%20%20%20%20%20%20%20%20fps%20%3D%20get_arg('fps')%0A%20%20%20%20%20%20%20%20n_frames%20%3D%20fps%20*%20get_arg('dur')%0A%0A%20%20%20%20%20%20%20%20xmin%2C%20xmax%2C%20ymin%2C%20ymax%2C%20xc%2C%20yc%2C%20rad%20%3D%20map(%0A%20%20%20%20%20%20%20%20%20%20%20%20get_arg%2C%20%5B'xmin'%2C%20'xmax'%2C%20'ymin'%2C%20'ymax'%2C%20'xc'%2C%20'yc'%2C%20'rad'%5D)%0A%0A%20%20%20%20%20%20%20%20its%2C%20cores%2C%20pal%2C%20width%2C%20height%20%3D%20map(get_arg%2C%20%5B'its'%2C%20'cores'%2C%20'pal'%2C%20'width'%2C%20'height'%5D)%0A%0A%20%20%20%20%20%20%20%20if%20not%20exported%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20img_sq%20%3D%20video_seq_mp(sq%2C%20xmin%2C%20xmax%2C%20ymin%2C%20ymax%2C%20xc%2C%20yc%2C%20rad%2C%20n_frames%2C%20cores%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20its%3Dits%2C%20pal%3Dpal%2C%20w%3Dwidth%2C%20h%3Dheight)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20right_now%20%3D%20datetime.now()%0A%20%20%20%20%20%20%20%20%20%20%20%20render_video(fname%2C%20img_sq%2C%20fps%3Dfps%2C%20quiet%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20print('Wrote%20%7B%7D%20in%20%7B%7Ds.'.format(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fname%2C%20(datetime.now()-right_now).total_seconds()%0A%20%20%20%20%20%20%20%20%20%20%20%20))%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20args%2C%0A%20%20%20%20%20%20%20%20cores%2C%0A%20%20%20%20%20%20%20%20exported%2C%0A%20%20%20%20%20%20%20%20fname%2C%0A%20%20%20%20%20%20%20%20fps%2C%0A%20%20%20%20%20%20%20%20get_arg%2C%0A%20%20%20%20%20%20%20%20height%2C%0A%20%20%20%20%20%20%20%20img_sq%2C%0A%20%20%20%20%20%20%20%20its%2C%0A%20%20%20%20%20%20%20%20n_frames%2C%0A%20%20%20%20%20%20%20%20pal%2C%0A%20%20%20%20%20%20%20%20rad%2C%0A%20%20%20%20%20%20%20%20right_now%2C%0A%20%20%20%20%20%20%20%20sq%2C%0A%20%20%20%20%20%20%20%20width%2C%0A%20%20%20%20%20%20%20%20xc%2C%0A%20%20%20%20%20%20%20%20xmax%2C%0A%20%20%20%20%20%20%20%20xmin%2C%0A%20%20%20%20%20%20%20%20yc%2C%0A%20%20%20%20%20%20%20%20ymax%2C%0A%20%20%20%20%20%20%20%20ymin%2C%0A%20%20%20%20)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
